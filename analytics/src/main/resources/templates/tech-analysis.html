<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Technical Analysis</title>
    <link rel="stylesheet" th:href="@{/style.css}"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>

        .page-container{
            max-width: 900px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .table-slider {
            margin-left: 20px;
        }

        body {
            margin: auto;
        }

        h1 {
            max-width: 70%;
            text-align: center;
            font-size: 38px;
        }

        .charts-wrap {
            max-width: 850px;
            width: 100%;
            margin-bottom: 38px;
            padding: 0 24px;
            display: flex;
            flex-direction: row;
            justify-items: center;
            align-items: center;
            gap: 22px;
        }

        .chart-card {
            margin-top: 20px;
            width: 100%;
            background: #ffffff;
            border: 1px solid #e5e9ef;
            border-radius: 18px;
            padding: 18px 20px;
            box-shadow: 0 10px 28px rgba(0,0,0,.07);
        }

        .chart-title{
            font-weight: 800;
            color:#1f2a37;
            margin: 4px 0 10px 2px;
        }

        canvas {
            width: 100% !important;
            height: 360px !important;
        }

        #volumeChart {
            height: 360px !important;
        }

        .chart-card canvas {
            width: 100% !important;
            height: 420px !important;
        }

        #volumeChart {
            height: 260px !important;
        }

    </style>
</head>
<body>

    <div class="page-container">
        <header class="navbar">
            <div class="nav-title">Digital Asset Analytics System</div>
            <nav class="nav-links">
                <a th:href="@{/}">Home</a>
                <a th:href="@{/tech-analysis-form}">Technical Analysis</a>
                <a th:href="@{/lstm-form}">LSTM Forecast</a>
                <a th:href="@{/nlp}">Sentiment Analysis</a>
            </nav>
        </header>

        <h1>
            TECHNICAL ANALYSIS <span th:text="${symbol.toUpperCase()}"></span>
            (<span th:text="${timeframe.toUpperCase()}"></span>)
        </h1>


        <div class="charts-wrap">
            <div class="chart-card">
                <div class="chart-title">Price + Bands + MAs</div>
                <canvas id="priceChart"></canvas>
            </div>
        </div>


        <div class="table-slider">
            <table>
                <thead>
                <tr>
                    <th>Date</th>
                    <th>Open</th>
                    <th>High</th>
                    <th>Low</th>
                    <th>Close</th>
                    <th>Volume</th>

                    <th>RSI14</th>
                    <th>MACD</th>
                    <th>MACD Signal</th>
                    <th>MACD Hist</th>
                    <th>Stoch %K</th>
                    <th>Stoch %D</th>
                    <th>ADX14</th>
                    <th>CCI20</th>
                    <th>SMA20</th>
                    <th>EMA20</th>
                    <th>WMA20</th>
                    <th>BB Mid</th>
                    <th>BB Upper</th>
                    <th>BB Lower</th>
                    <th>VMA20</th>
                    <th>RSI Sig</th>
                    <th>MACD Sig</th>
                    <th>Stoch Sig</th>
                    <th>CCI Sig</th>
                    <th>ADX Sig</th>
                    <th>SMA Sig</th>
                    <th>EMA Sig</th>
                    <th>WMA Sig</th>
                    <th>BB Sig</th>
                    <th>Vol Sig</th>
                    <th>Overall Signal</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="row : ${data}">
        <!--            <td th:text="${row['date']}"></td>-->
                    <td th:text="${#strings.substring(row['date'], 0, 10)}"></td>
                    <td th:text="${row['open']}"></td>
                    <td th:text="${row['high']}"></td>
                    <td th:text="${row['low']}"></td>
                    <td th:text="${row['close']}"></td>
                    <td th:text="${row['volume']}"></td>

                    <td th:text="${row['rsi14']}"></td>
                    <td th:text="${row['macd']}"></td>
                    <td th:text="${row['macd_signal']}"></td>
                    <td th:text="${row['macd_hist']}"></td>
                    <td th:text="${row['stoch_k']}"></td>
                    <td th:text="${row['stoch_d']}"></td>
                    <td th:text="${row['adx14']}"></td>
                    <td th:text="${row['cci20']}"></td>
                    <td th:text="${row['sma20']}"></td>
                    <td th:text="${row['ema20']}"></td>
                    <td th:text="${row['wma20']}"></td>
                    <td th:text="${row['bb_mid']}"></td>
                    <td th:text="${row['bb_upper']}"></td>
                    <td th:text="${row['bb_lower']}"></td>
                    <td th:text="${row['vma20']}"></td>
                    <td th:text="${row['sig_rsi']}"></td>
                    <td th:text="${row['sig_macd']}"></td>
                    <td th:text="${row['sig_stoch']}"></td>
                    <td th:text="${row['sig_cci']}"></td>
                    <td th:text="${row['sig_adx']}"></td>
                    <td th:text="${row['sig_sma']}"></td>
                    <td th:text="${row['sig_ema']}"></td>
                    <td th:text="${row['sig_wma']}"></td>
                    <td th:text="${row['sig_bb']}"></td>
                    <td th:text="${row['sig_vma']}"></td>

                    <td th:text="${row['signal_overall']}" style="font-weight: bold;"></td>

        <!--            <td th:text="${row['signal_overall']}"-->
        <!--                th:class="${'signal ' + row['signal_overall']}"></td>-->
                </tr>
                </tbody>
            </table>
        </div>

<!--        <div class="charts-wrap">-->
<!--            <div class="chart-card">-->
<!--                <div class="chart-title">Volume + VMA</div>-->
<!--                <canvas id="volumeChart"></canvas>-->
<!--            </div>-->
<!--        </div>-->
    </div>

    <script th:inline="javascript">
        // Thymeleaf injects List<Map<...>> as JSON
        const rows = /*[[${data}]]*/ [];

        const toDate = (d) => d ? String(d).substring(0,10) : null;
        const num = (x) => (x === null || x === undefined || x === "" ? null : Number(x));

        const labels = rows.map(r => toDate(r.date)).filter(Boolean);

        const close = rows.map(r => num(r.close));
        const sma   = rows.map(r => num(r.sma20));
        const ema   = rows.map(r => num(r.ema20));
        const bbU   = rows.map(r => num(r.bb_upper));
        const bbL   = rows.map(r => num(r.bb_lower));

        const volume = rows.map(r => num(r.volume));
        const vma    = rows.map(r => num(r.vma20));

        Chart.defaults.font.family = "system-ui, -apple-system, Segoe UI, Roboto, Arial";
        Chart.defaults.color = "#334155";

        const priceCtx = document.getElementById("priceChart");

        new Chart(priceCtx, {
            type: "line",
            data: {
                labels,
                datasets: [
                    {
                        label: "BB Upper",
                        data: bbU,
                        borderColor: "rgba(59,130,246,.55)",
                        borderWidth: 1.5,
                        pointRadius: 0,
                        tension: 0.2
                    },
                    {
                        label: "BB Lower",
                        data: bbL,
                        borderColor: "rgba(59,130,246,.55)",
                        borderWidth: 1.5,
                        pointRadius: 0,
                        tension: 0.2,
                        fill: "-1",
                        backgroundColor: "rgba(59,130,246,.10)"
                    },

                    {
                        label: "Close",
                        data: close,
                        borderColor: "rgba(17,24,39,.95)",
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.15
                    },
                    {
                        label: "SMA",
                        data: sma,
                        borderColor: "rgba(16,185,129,.85)",
                        borderWidth: 1.8,
                        pointRadius: 0,
                        tension: 0.2
                    },
                    {
                        label: "EMA",
                        data: ema,
                        borderColor: "rgba(245,158,11,.9)",
                        borderWidth: 1.8,
                        pointRadius: 0,
                        tension: 0.2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: "index", intersect: false },
                plugins: {
                    legend: { position: "top", labels: { boxWidth: 14, boxHeight: 14, usePointStyle: true } },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y?.toLocaleString?.() ?? ctx.parsed.y}`
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { color: "rgba(148,163,184,.18)" },
                        ticks: { maxTicksLimit: 10 }
                    },
                    y: {
                        grid: { color: "rgba(148,163,184,.18)" },
                        ticks: {
                            callback: (v) => Number(v).toLocaleString()
                        }
                    }
                }
            }
        });

        const volCtx = document.getElementById("volumeChart");

        new Chart(volCtx, {
            data: {
                labels,
                datasets: [
                    {
                        type: "bar",
                        label: "Volume",
                        data: volume,
                        backgroundColor: "rgba(100,116,139,.35)",
                        borderWidth: 0
                    },
                    {
                        type: "line",
                        label: "VMA",
                        data: vma,
                        borderColor: "rgba(99,102,241,.95)",
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.2,
                        yAxisID: "y"
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: "index", intersect: false },
                plugins: {
                    legend: { position: "top", labels: { boxWidth: 14, boxHeight: 14, usePointStyle: true } }
                },
                scales: {
                    x: {
                        grid: { color: "rgba(148,163,184,.18)" },
                        ticks: { maxTicksLimit: 10 }
                    },
                    y: {
                        grid: { color: "rgba(148,163,184,.18)" },
                        ticks: { callback: (v) => Number(v).toLocaleString() }
                    }
                }
            }
        });
    </script>


</body>
</html>
